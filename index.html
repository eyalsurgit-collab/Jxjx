<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="××©×™××•×ª">
<link rel="manifest" href="#" id="manifestLink">
<title>×™×•××Ÿ ××©×™××•×ª</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&family=Rubik+Mono+One&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --bg2: #111118;
  --surface: #16161f;
  --surface2: #1e1e2a;
  --surface3: #252535;
  --border: #2a2a3d;
  --border2: #333348;
  --accent: #6c63ff;
  --accent2: #ff6584;
  --accent3: #43e97b;
  --yellow: #f9ca24;
  --blue: #4facfe;
  --text: #eeeef5;
  --text2: #9999bb;
  --text3: #555570;
  --radius: 16px;
  --radius-sm: 10px;
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Rubik', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  min-height: -webkit-fill-available;
  overflow-x: hidden;
}

/* Animated background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 60% 40% at 80% 10%, rgba(108,99,255,0.08) 0%, transparent 60%),
    radial-gradient(ellipse 40% 30% at 20% 80%, rgba(255,101,132,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 50% 50% at 50% 50%, rgba(67,233,123,0.03) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 680px;
  margin: 0 auto;
  padding: 0 16px 100px;
  position: relative;
  z-index: 1;
}

/* ---- NAME SCREEN ---- */
#nameScreen {
  display: flex; align-items: center; justify-content: center;
  min-height: 100vh; padding: 20px;
}

.name-card {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 24px;
  padding: 48px 32px;
  max-width: 380px;
  width: 100%;
  text-align: center;
  box-shadow: var(--shadow), 0 0 0 1px rgba(108,99,255,0.1);
  animation: fadeUp 0.5s ease;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.app-icon {
  width: 80px; height: 80px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 22px;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.2rem;
  margin: 0 auto 24px;
  box-shadow: 0 8px 24px rgba(108,99,255,0.4);
}

.name-card h1 {
  font-family: 'Rubik Mono One', monospace;
  font-size: 1.6rem;
  margin-bottom: 8px;
  background: linear-gradient(135deg, var(--text), var(--text2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

.name-card p { color: var(--text2); font-size: 0.9rem; margin-bottom: 32px; line-height: 1.6; }

.input-wrap {
  position: relative;
  margin-bottom: 14px;
}

.input-wrap input {
  width: 100%;
  background: var(--surface2);
  border: 2px solid var(--border2);
  border-radius: var(--radius-sm);
  padding: 14px 18px;
  color: var(--text);
  font-family: 'Rubik', sans-serif;
  font-size: 1rem;
  outline: none;
  transition: all 0.2s;
  text-align: center;
}

.input-wrap input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(108,99,255,0.15); }

.btn-main {
  width: 100%;
  padding: 14px;
  border-radius: var(--radius-sm);
  border: none;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  font-family: 'Rubik', sans-serif;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(108,99,255,0.4);
}

.btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(108,99,255,0.5); }
.btn-main:active { transform: translateY(0); }

/* ---- MAIN APP ---- */
#mainApp { display: none; }

/* Header */
.app-header {
  padding: 56px 0 24px;
  position: relative;
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.header-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-icon {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
}

.logo-text {
  font-family: 'Rubik Mono One', monospace;
  font-size: 1.1rem;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

.user-chip {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 50px;
  padding: 6px 12px 6px 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.user-chip:hover { border-color: var(--accent); }

.chip-avatar {
  width: 28px; height: 28px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; font-weight: 700;
}

.chip-name { font-size: 0.85rem; font-weight: 500; }

/* Live indicator */
.live-bar {
  display: flex; align-items: center; gap: 6px;
  font-size: 0.75rem; color: var(--accent3);
  margin-bottom: 20px;
}

.live-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--accent3);
  animation: pulse 2s infinite;
}

@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }

/* Stats */
.stats-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.stat-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 12px;
  text-align: center;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.stat-box::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
}

.stat-box.total::before { background: linear-gradient(90deg, var(--accent), var(--blue)); }
.stat-box.done::before { background: linear-gradient(90deg, var(--accent3), #00b09b); }
.stat-box.pending::before { background: linear-gradient(90deg, var(--yellow), #f0932b); }

.stat-num { font-size: 2rem; font-weight: 900; line-height: 1; margin-bottom: 4px; }
.stat-box.total .stat-num { color: var(--accent); }
.stat-box.done .stat-num { color: var(--accent3); }
.stat-box.pending .stat-num { color: var(--yellow); }
.stat-lbl { font-size: 0.72rem; color: var(--text2); }

/* Add task card */
.add-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
  transition: border-color 0.3s, box-shadow 0.3s;
}

.add-card:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(108,99,255,0.08);
}

.add-card-title {
  font-size: 0.8rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 14px;
  font-weight: 600;
}

.add-fields { display: flex; flex-direction: column; gap: 10px; }

.field-input {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  color: var(--text);
  font-family: 'Rubik', sans-serif;
  font-size: 0.95rem;
  outline: none;
  width: 100%;
  transition: border-color 0.2s;
}

.field-input:focus { border-color: var(--accent); }
input[type="date"].field-input { color-scheme: dark; }

.add-row { display: flex; gap: 10px; }
.add-row .field-input { flex: 1; }

/* Image upload */
.img-upload-btn {
  background: var(--surface2);
  border: 2px dashed var(--border2);
  border-radius: var(--radius-sm);
  padding: 12px;
  color: var(--text2);
  font-family: 'Rubik', sans-serif;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.img-upload-btn:hover { border-color: var(--accent); color: var(--accent); }

.img-preview {
  position: relative;
  display: none;
}

.img-preview img {
  width: 100%;
  height: 140px;
  object-fit: cover;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border2);
}

.img-remove {
  position: absolute;
  top: 8px; left: 8px;
  width: 28px; height: 28px;
  border-radius: 50%;
  background: rgba(0,0,0,0.7);
  border: none;
  color: white;
  cursor: pointer;
  font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
}

.btn-add {
  padding: 13px;
  border-radius: var(--radius-sm);
  border: none;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  font-family: 'Rubik', sans-serif;
  font-weight: 700;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
  margin-top: 4px;
}

.btn-add:hover { opacity: 0.9; transform: translateY(-1px); }
.btn-add:active { transform: translateY(0); }

/* Filters */
.filters {
  display: flex; gap: 8px; margin-bottom: 16px;
  overflow-x: auto; padding-bottom: 4px;
  scrollbar-width: none;
}
.filters::-webkit-scrollbar { display: none; }

.filter-pill {
  padding: 7px 18px;
  border-radius: 50px;
  border: 1px solid var(--border2);
  background: transparent;
  color: var(--text2);
  font-family: 'Rubik', sans-serif;
  font-size: 0.82rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}

.filter-pill.active {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
  box-shadow: 0 4px 12px rgba(108,99,255,0.4);
}

/* Tasks */
.tasks-list { display: flex; flex-direction: column; gap: 12px; }

.empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--text3);
}

.empty-icon { font-size: 3.5rem; margin-bottom: 16px; opacity: 0.5; }
.empty p { font-size: 0.9rem; }

/* Task card */
.task-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: all 0.25s;
  animation: slideIn 0.3s ease;
  position: relative;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-12px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.task-card:hover { border-color: var(--border2); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
.task-card.done { opacity: 0.55; }
.task-card.done .task-title { text-decoration: line-through; color: var(--text3); }

/* Card accent bar */
.task-card::before {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 3px; height: 100%;
  background: linear-gradient(180deg, var(--accent), var(--accent2));
  opacity: 0;
  transition: opacity 0.2s;
}
.task-card:hover::before { opacity: 1; }

.task-img {
  width: 100%;
  max-height: 200px;
  object-fit: cover;
  border-bottom: 1px solid var(--border);
  display: block;
}

.task-body { padding: 16px; }

.task-top {
  display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;
}

.task-avatar {
  width: 36px; height: 36px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.78rem; font-weight: 700; flex-shrink: 0;
}

.task-info { flex: 1; min-width: 0; }

.task-title {
  font-size: 0.98rem;
  font-weight: 600;
  line-height: 1.4;
  margin-bottom: 8px;
  word-break: break-word;
}

.task-tags {
  display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
}

.tag {
  font-size: 0.72rem;
  padding: 3px 10px;
  border-radius: 50px;
  font-weight: 500;
  white-space: nowrap;
}

.tag-user { background: rgba(108,99,255,0.15); color: #9b95ff; border: 1px solid rgba(108,99,255,0.25); }
.tag-date { background: rgba(249,202,36,0.12); color: #f9ca24; border: 1px solid rgba(249,202,36,0.22); }
.tag-overdue { background: rgba(255,101,132,0.12); color: #ff6584; border: 1px solid rgba(255,101,132,0.25); }
.tag-done { background: rgba(67,233,123,0.12); color: #43e97b; border: 1px solid rgba(67,233,123,0.22); }
.tag-pending { background: rgba(249,202,36,0.12); color: #f9ca24; border: 1px solid rgba(249,202,36,0.22); }

.task-actions {
  display: flex; gap: 8px; margin-top: 12px; align-items: center;
}

.btn-toggle {
  flex: 1;
  padding: 9px 14px;
  border-radius: 8px;
  border: 1px solid;
  font-family: 'Rubik', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-toggle.mark-done {
  background: rgba(67,233,123,0.08);
  border-color: rgba(67,233,123,0.3);
  color: var(--accent3);
}
.btn-toggle.mark-done:hover { background: rgba(67,233,123,0.18); }

.btn-toggle.mark-undone {
  background: rgba(249,202,36,0.08);
  border-color: rgba(249,202,36,0.3);
  color: var(--yellow);
}
.btn-toggle.mark-undone:hover { background: rgba(249,202,36,0.18); }

.btn-del {
  width: 36px; height: 36px;
  border-radius: 8px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--text3);
  cursor: pointer;
  transition: all 0.2s;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem;
}
.btn-del:hover { background: rgba(255,101,132,0.1); border-color: rgba(255,101,132,0.3); color: var(--accent2); }

/* Activity */
.task-activity {
  border-top: 1px solid var(--border);
  padding: 10px 16px;
  display: flex; flex-direction: column; gap: 5px;
}

.act-item {
  display: flex; gap: 8px; align-items: center;
  font-size: 0.75rem; color: var(--text2);
}

.act-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--border2); flex-shrink: 0; }
.act-user { font-weight: 600; }
.act-time { font-size: 0.68rem; color: var(--text3); margin-right: auto; }

/* Toast */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 50px;
  padding: 10px 20px;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text);
  box-shadow: var(--shadow);
  opacity: 0;
  transition: all 0.3s;
  pointer-events: none;
  z-index: 100;
  white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Bottom nav feel */
.bottom-safe { height: env(safe-area-inset-bottom, 0); }
</style>
</head>
<body>

<!-- Name Screen -->
<div id="nameScreen">
  <div class="name-card">
    <div class="app-icon">ğŸ“‹</div>
    <h1>×™×•××Ÿ ××©×™××•×ª</h1>
    <p>×™×•××Ÿ ××©×•×ª×£ ×œ×›×œ ×”×¦×•×•×ª<br>×¢×“×›×•× ×™× ×‘×–××Ÿ ×××ª ×œ×›×•×œ×</p>
    <div class="input-wrap">
      <input type="text" id="nameInput" placeholder="××” ×”×©× ×©×œ×š?" maxlength="30" autocomplete="off">
    </div>
    <button class="btn-main" id="startBtn">×›× ×™×¡×” ğŸš€</button>
  </div>
</div>

<!-- Main App -->
<div id="mainApp">
  <div class="container">
    <div class="app-header">
      <div class="header-top">
        <div class="header-logo">
          <div class="logo-icon">ğŸ“‹</div>
          <span class="logo-text">TASKS</span>
        </div>
        <div class="user-chip" id="userChip">
          <div class="chip-avatar" id="chipAvatar"></div>
          <span class="chip-name" id="chipName"></span>
        </div>
      </div>
      <div class="live-bar">
        <div class="live-dot"></div>
        <span>××—×•×‘×¨ Â· ×¢×“×›×•× ×™× ×‘×–××Ÿ ×××ª</span>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-box total"><div class="stat-num" id="statTotal">0</div><div class="stat-lbl">××©×™××•×ª</div></div>
      <div class="stat-box done"><div class="stat-num" id="statDone">0</div><div class="stat-lbl">×‘×•×¦×¢×• âœ…</div></div>
      <div class="stat-box pending"><div class="stat-num" id="statPending">0</div><div class="stat-lbl">×××ª×™× ×•×ª</div></div>
    </div>

    <!-- Add Task -->
    <div class="add-card">
      <div class="add-card-title">âœ¦ ××©×™××” ×—×“×©×”</div>
      <div class="add-fields">
        <input type="text" class="field-input" id="taskTitle" placeholder="××” ×¦×¨×™×š ×œ×¢×©×•×ª?" maxlength="120">
        <div class="add-row">
          <input type="date" class="field-input" id="taskDate">
        </div>

        <!-- Image upload -->
        <div id="imgUploadArea">
          <label class="img-upload-btn" for="imgInput">
            ğŸ“· ×”×•×¡×£ ×ª××•× ×” (××•×¤×¦×™×•× ×œ×™)
          </label>
          <input type="file" id="imgInput" accept="image/*" style="display:none">
        </div>
        <div class="img-preview" id="imgPreview">
          <img id="imgPreviewSrc" src="" alt="×ª××•× ×”">
          <button class="img-remove" id="imgRemove">âœ•</button>
        </div>

        <button class="btn-add" id="addBtn">+ ×”×•×¡×£ ××©×™××”</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <button class="filter-pill active" data-filter="all">×”×›×œ</button>
      <button class="filter-pill" data-filter="pending">×××ª×™× ×•×ª</button>
      <button class="filter-pill" data-filter="done">×‘×•×¦×¢×•</button>
    </div>

    <!-- Tasks list -->
    <div class="tasks-list" id="tasksList"></div>
    <div class="bottom-safe"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAWsxdPU1kL6gX0nFupMWdZfTmNQ7a8fCw",
  authDomain: "olam-f9e20.firebaseapp.com",
  databaseURL: "https://olam-f9e20-default-rtdb.firebaseio.com",
  projectId: "olam-f9e20",
  storageBucket: "olam-f9e20.firebasestorage.app",
  messagingSenderId: "772293528012",
  appId: "1:772293528012:web:0f2235f403bb8af9f07569"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const tasksRef = ref(db, 'tasks');

let tasks = {};
let filter = 'all';
let currentUser = localStorage.getItem('tjname') || '';
let pendingImage = null;
let lastTaskCount = 0;
let isFirstLoad = true;

const colors = ['#6c63ff','#ff6584','#43e97b','#f9ca24','#4facfe','#f97316','#a855f7','#06b6d4'];
const bgColors = ['rgba(108,99,255,0.15)','rgba(255,101,132,0.15)','rgba(67,233,123,0.15)','rgba(249,202,36,0.15)','rgba(79,172,254,0.15)','rgba(249,115,22,0.15)','rgba(168,85,247,0.15)','rgba(6,182,212,0.15)'];

function getColorIdx(name) {
  let h = 0;
  for (let c of (name||'')) h = c.charCodeAt(0) + ((h<<5)-h);
  return Math.abs(h) % colors.length;
}
function getColor(name) { return colors[getColorIdx(name)]; }
function getBg(name) { return bgColors[getColorIdx(name)]; }
function getInitials(name) { return (name||'?').trim().split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)||'?'; }
function formatDate(d) { if(!d) return null; const [y,m,day]=d.split('-'); return `${day}/${m}/${y}`; }
function isOverdue(d) { if(!d) return false; return new Date(d) < new Date(new Date().toDateString()); }
function formatTime(ts) { if(!ts) return ''; const d=new Date(ts); return `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; }

function showToast(msg, duration=3000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// Notifications
async function requestNotifications() {
  if ('Notification' in window && Notification.permission === 'default') {
    await Notification.requestPermission();
  }
}

function sendNotification(title, body) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body, icon: 'ğŸ“‹' });
  }
}

// PWA Manifest
function setupPWA() {
  const manifest = {
    name: '×™×•××Ÿ ××©×™××•×ª',
    short_name: '××©×™××•×ª',
    description: '×™×•××Ÿ ××©×™××•×ª ××©×•×ª×£ ×œ×›×œ ×”×¦×•×•×ª',
    start_url: window.location.href,
    display: 'standalone',
    background_color: '#0a0a0f',
    theme_color: '#6c63ff',
    orientation: 'portrait',
    icons: [
      { src: 'https://api.iconify.design/twemoji:clipboard.svg?width=192&height=192', sizes: '192x192', type: 'image/svg+xml' },
      { src: 'https://api.iconify.design/twemoji:clipboard.svg?width=512&height=512', sizes: '512x512', type: 'image/svg+xml' }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  document.getElementById('manifestLink').setAttribute('href', url);
}

setupPWA();

function updateAvatar(name) {
  const idx = getColorIdx(name);
  const av = document.getElementById('chipAvatar');
  if (!av) return;
  av.style.background = bgColors[idx];
  av.style.color = colors[idx];
  av.textContent = getInitials(name);
}

function showApp(name) {
  currentUser = name;
  document.getElementById('nameScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('chipName').textContent = name;
  updateAvatar(name);
  document.getElementById('taskDate').value = new Date().toISOString().split('T')[0];
  requestNotifications();
  showToast(`ğŸ‘‹ ×©×œ×•× ${name}!`);
}

// Image handling
document.getElementById('imgInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    pendingImage = ev.target.result;
    document.getElementById('imgPreviewSrc').src = pendingImage;
    document.getElementById('imgPreview').style.display = 'block';
    document.getElementById('imgUploadArea').style.display = 'none';
  };
  reader.readAsDataURL(file);
});

document.getElementById('imgRemove').addEventListener('click', () => {
  pendingImage = null;
  document.getElementById('imgPreview').style.display = 'none';
  document.getElementById('imgUploadArea').style.display = 'block';
  document.getElementById('imgInput').value = '';
});

function addTask() {
  const title = document.getElementById('taskTitle').value.trim();
  const date = document.getElementById('taskDate').value;
  if (!title) { document.getElementById('taskTitle').focus(); showToast('âœï¸ ×›×ª×•×‘ ×ª×™××•×¨ ××©×™××”'); return; }

  push(tasksRef, {
    title, date: date||null, user: currentUser,
    done: false, doneBy: null, createdAt: Date.now(),
    image: pendingImage || null,
    activity: [{ user: currentUser, action: '×”×•×¡×™×£ ××©×™××”', ts: Date.now() }]
  });

  document.getElementById('taskTitle').value = '';
  pendingImage = null;
  document.getElementById('imgPreview').style.display = 'none';
  document.getElementById('imgUploadArea').style.display = 'block';
  document.getElementById('imgInput').value = '';
  showToast('âœ… ××©×™××” × ×•×¡×¤×”!');
}

function toggleDone(id) {
  const task = tasks[id];
  if (!task) return;
  const newDone = !task.done;
  const activity = [...(task.activity||[]), {
    user: currentUser,
    action: newDone ? '×¡×™××Ÿ ×›×‘×•×¦×¢ âœ…' : '×¡×™××Ÿ ×›×œ× ×‘×•×¦×¢ â†©ï¸',
    ts: Date.now()
  }];
  update(ref(db,'tasks/'+id), { done: newDone, doneBy: newDone?currentUser:null, activity });
  showToast(newDone ? 'âœ… ××¢×•×œ×”! ×‘×•×¦×¢!' : 'â†©ï¸ ×¡×•××Ÿ ×›×œ× ×‘×•×¦×¢');
}

function deleteTask(id) {
  if (!confirm('×œ××—×•×§ ××ª ×”××©×™××”?')) return;
  remove(ref(db,'tasks/'+id));
  showToast('ğŸ—‘ × ××—×§');
}

function updateStats() {
  const arr = Object.values(tasks);
  const done = arr.filter(t=>t.done).length;
  document.getElementById('statTotal').textContent = arr.length;
  document.getElementById('statDone').textContent = done;
  document.getElementById('statPending').textContent = arr.length - done;
}

function render() {
  updateStats();
  let arr = Object.entries(tasks).map(([id,t])=>({id,...t}));
  if (filter==='done') arr = arr.filter(t=>t.done);
  if (filter==='pending') arr = arr.filter(t=>!t.done);
  arr.sort((a,b)=>{
    if(a.date&&b.date) return a.date.localeCompare(b.date);
    if(a.date) return -1; if(b.date) return 1;
    return (b.createdAt||0)-(a.createdAt||0);
  });

  const list = document.getElementById('tasksList');
  if (arr.length===0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ—‚ï¸</div><p>××™×Ÿ ××©×™××•×ª ×œ×”×¦×™×’</p></div>`;
    return;
  }

  list.innerHTML = arr.map(task => {
    const color = getColor(task.user);
    const bg = getBg(task.user);
    const overdue = isOverdue(task.date) && !task.done;
    const acts = (task.activity||[]).slice(-2).reverse().map(a =>
      `<div class="act-item">
        <div class="act-dot"></div>
        <span class="act-user" style="color:${getColor(a.user)}">${a.user}</span>
        <span>${a.action}</span>
        <span class="act-time">${formatTime(a.ts)}</span>
      </div>`
    ).join('');

    return `<div class="task-card ${task.done?'done':''}">
      ${task.image ? `<img class="task-img" src="${task.image}" alt="×ª××•× ×”">` : ''}
      <div class="task-body">
        <div class="task-top">
          <div class="task-avatar" style="background:${bg};color:${color}">${getInitials(task.user)}</div>
          <div class="task-info">
            <div class="task-title">${task.title}</div>
            <div class="task-tags">
              <span class="tag tag-user">${task.user}</span>
              ${task.date?`<span class="tag ${overdue?'tag-overdue':'tag-date'}">${overdue?'âš ï¸ ':'ğŸ“… '}${formatDate(task.date)}</span>`:''}
              <span class="tag ${task.done?'tag-done':'tag-pending'}">${task.done?'âœ… ×‘×•×¦×¢':'â³ ×××ª×™×Ÿ'}</span>
            </div>
          </div>
        </div>
        <div class="task-actions">
          <button class="btn-toggle ${task.done?'mark-undone':'mark-done'}" data-id="${task.id}" data-action="toggle">
            ${task.done?'â†©ï¸ ×œ× ×‘×•×¦×¢':'âœ… ×¡××Ÿ ×›×‘×•×¦×¢'}
          </button>
          <button class="btn-del" data-id="${task.id}" data-action="delete">ğŸ—‘</button>
        </div>
      </div>
      ${acts?`<div class="task-activity">${acts}</div>`:''}
    </div>`;
  }).join('');

  list.querySelectorAll('[data-action]').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.dataset.action==='toggle') toggleDone(btn.dataset.id);
      if (btn.dataset.action==='delete') deleteTask(btn.dataset.id);
    });
  });
}

// Firebase listener
onValue(tasksRef, (snapshot) => {
  const newTasks = snapshot.val() || {};
  const newCount = Object.keys(newTasks).length;

  // Notify on new task (not on first load)
  if (!isFirstLoad && newCount > lastTaskCount) {
    const newTaskIds = Object.keys(newTasks).filter(id => !tasks[id]);
    newTaskIds.forEach(id => {
      const t = newTasks[id];
      if (t.user !== currentUser) {
        sendNotification('ğŸ“‹ ××©×™××” ×—×“×©×”!', `${t.user} ×”×•×¡×™×£: ${t.title}`);
        showToast(`ğŸ”” ${t.user} ×”×•×¡×™×£ ××©×™××” ×—×“×©×”`);
      }
    });
  }

  tasks = newTasks;
  lastTaskCount = newCount;
  isFirstLoad = false;

  if (document.getElementById('mainApp').style.display === 'block') render();
});

// Events
document.getElementById('startBtn').addEventListener('click', () => {
  const name = document.getElementById('nameInput').value.trim();
  if (!name) { document.getElementById('nameInput').focus(); return; }
  localStorage.setItem('tjname', name);
  showApp(name);
});

document.getElementById('nameInput').addEventListener('keydown', e => {
  if (e.key==='Enter') document.getElementById('startBtn').click();
});

document.getElementById('addBtn').addEventListener('click', addTask);
document.getElementById('taskTitle').addEventListener('keydown', e => {
  if (e.key==='Enter') addTask();
});

document.getElementById('userChip').addEventListener('click', () => {
  if (!confirm('×œ×”×—×œ×™×£ ×©×?')) return;
  localStorage.removeItem('tjname');
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('nameScreen').style.display = 'flex';
  document.getElementById('nameInput').value = '';
});

document.querySelectorAll('.filter-pill').forEach(btn => {
  btn.addEventListener('click', () => {
    filter = btn.dataset.filter;
    document.querySelectorAll('.filter-pill').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    render();
  });
});

// Auto-login
if (currentUser) showApp(currentUser);
</script>
</body>
</html>
